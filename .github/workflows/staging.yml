name: Deploy Express API with Prisma to cPanel

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
      - name: Deploy to cPanel via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            # Menentukan path deploy
            DEPLOY_PATH="/home/metrosof/api/surau-quran-staging-api"
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH
            
            # Backup .env jika sudah ada
            if [ -f .env ]; then
              cp .env .env.backup
            fi
            
            # Backup node_modules jika ada
            if [ -d node_modules ]; then
              mv node_modules node_modules_backup
            fi
      
      - name: Compress entire project (excluding node_modules and git files)
        run: |
          # Exclude files/directories yang tidak perlu di-deploy
          echo "node_modules/" > .deployignore
          echo ".git/" >> .deployignore
          echo ".github/" >> .deployignore
          echo ".gitignore" >> .deployignore
          echo ".env" >> .deployignore
          
          # Compress seluruh project kecuali yang di-exclude
          tar --exclude-from=.deployignore -czf build.tar.gz .
          
      - name: Deploy files to cPanel
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }} 
          source: "build.tar.gz"
          target: "/home/metrosof/api/surau-quran-staging-api"
          
      - name: Setup application in cPanel
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }} 
          script: |
            cd /home/metrosof/api/surau-quran-staging-api
            
            # Extract files
            tar -xzf build.tar.gz
            
            # Restore .env dari backup
            if [ -f .env.backup ]; then
              cp .env.backup .env
              rm .env.backup
            else
              echo "DATABASE_URL='${{ secrets.DATABASE_URL }}'" > .env
            fi
            
            # Restore node_modules jika ada backup
            if [ -d node_modules_backup ]; then
              rm -rf node_modules
              mv node_modules_backup node_modules
            else
              npm ci --only=production
            fi
            
            # Generate Prisma client
            npx prisma generate
            
            # Restart atau mulai aplikasi dengan PM2
            if [ -f ~/.pm2/pm2.pid ]; then 
              pm2 restart surau-quran-api || pm2 start index.js --name surau-quran-api
            else 
              pm2 start index.js --name surau-quran-api
            fi
            
            # Bersihkan file tar
            rm build.tar.gz